## 你已选择的目标
- 选 B：小程序通过 **微信云开发 CloudBase** 调用后端（不走外部域名 request 白名单）。
- 演示阶段数据库用 **SQLite**（最快上线）。

## 重要说明（必须提前说清）
- 你当前的“咖啡地图”前端是 **H5 + Leaflet + 自定义瓦片**。
- **如果小程序“不走 WebView”**，就不能直接运行 Leaflet/H5 地图页面；要做同等体验需要重写前端（Canvas/自绘瓦片）——这不再是“最简单演示”。
- 因此我建议演示先分两步：
  - **Step 1（最简单，马上能演示）**：只把“后端 API + SQLite”上云，小程序能调用并展示“区域/商家列表”。
  - **Step 2（如果你最终仍想在小程序里看这张自定义地图）**：要么允许 WebView（但会涉及业务域名/备案），要么做小程序 Canvas 版地图（工作量大）。

下面的实施计划按 Step 1 来做（最符合你“不会部署 + 最简单”的诉求）。

## Step 1：后端上云（CloudBase 云托管）+ 小程序调用（wx.cloud.callContainer）
### 1) CloudBase 环境准备
- 微信云开发控制台 → 创建环境（测试环境即可）。
- 开通「云托管」。

### 2) 后端改造为云托管可运行（仓库需要落地的改动）
- 把 Flask 从 `debug=True` 的开发启动方式改为**生产启动**：
  - 新增 WSGI 入口（例如 `wsgi.py`）
  - 用 Gunicorn 启动（监听 `0.0.0.0:$PORT`，CloudBase 会注入 PORT）
- 配置化：
  - 读取环境变量 `PORT`
  - 读取环境变量 `DB_PATH`（默认指向容器内固定路径）
- SQLite 演示策略（最简单、但要知晓限制）：
  - 将 `server/database.db` 作为“初始模板”随镜像打包
  - 容器启动时如果运行目录没 db，则复制模板 db 到可写位置
  - **限制**：云托管通常是无状态/可重建的；演示可接受，正式版再迁移云数据库

### 3) CloudBase 云托管部署步骤（控制台操作）
- 新建云托管服务（例如 service 名称 `coffee-api`）
- 选择“从代码仓库/上传代码”部署
- 设置启动命令：`gunicorn wsgi:app -b 0.0.0.0:$PORT`
- 部署完成后，云托管会提供一个内部可访问服务标识（供小程序 callContainer）。

### 4) 小程序侧接入（不走外部域名）
- 小程序初始化云开发：`wx.cloud.init({ env: '你的环境ID' })`
- 调用后端 API（核心是 `wx.cloud.callContainer`）：
  - 请求 `/api/config`、`/api/data`
  - Header 里带 `X-WX-SERVICE: coffee-api`（你的云托管服务名）
- 演示页面最小实现：
  - 一个页面展示“区域列表 + 该区域商家列表”（完全不需要 WebView）

## Step 1 的“发布新版本”方式（对新手最友好）
### 后端发布
- 你本地改完代码：推送到 GitHub/Gitee → CloudBase 控制台点“重新部署”即可（或绑定仓库自动部署）。

### 小程序发布
- 你本地改完小程序代码：用微信开发者工具点击“上传”即可。

## Step 2（可选，后续如果你一定要在小程序里看这张自定义地图）
你必须二选一：
- **2A 走 WebView（实现最快，但会遇到业务域名/备案）**：把 `coffee_map.html + 瓦片` 放到静态托管或 COS+CDN，然后小程序 web-view 打开。
- **2B 不走 WebView（实现最慢，但无需业务域名）**：小程序用 Canvas 自己实现瓦片加载、双指缩放、平移（等价于重写 Leaflet 的核心交互）。

## 你确认后我会开始实施的内容（具体交付物）
- 后端：增加 WSGI 入口与 Gunicorn 启动方式、SQLite 初始化策略（仅演示）。
- 小程序：新增一个最小页面，使用 `wx.cloud.callContainer` 请求 `/api/config` 与 `/api/data` 并展示。
- 发布：提供“本地改完 → push → 控制台一键重部署”的操作清单。

如果你接受“Step 1 先做 API + 列表演示”，我就开始按这个方案改代码并给出部署清单。